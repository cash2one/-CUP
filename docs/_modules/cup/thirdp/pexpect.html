<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cup.thirdp.pexpect &mdash; cup 1.2.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="cup 1.2.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">cup 1.2.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for cup.thirdp.pexpect</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;Pexpect is a Python module for spawning child applications and controlling</span>
<span class="sd">them automatically. Pexpect can be used for automating interactive applications</span>
<span class="sd">such as ssh, ftp, passwd, telnet, etc. It can be used to a automate setup</span>
<span class="sd">scripts for duplicating software package installations on different servers. It</span>
<span class="sd">can be used for automated software testing. Pexpect is in the spirit of Don</span>
<span class="sd">Libes&#39; Expect, but Pexpect is pure Python. Other Expect-like modules for Python</span>
<span class="sd">require TCL and Expect or require C extensions to be compiled. Pexpect does not</span>
<span class="sd">use C, Expect, or TCL extensions. It should work on any platform that supports</span>
<span class="sd">the standard Python pty module. The Pexpect interface focuses on ease of use so</span>
<span class="sd">that simple tasks are easy.</span>

<span class="sd">There are two main interfaces to Pexpect -- the function, run() and the class,</span>
<span class="sd">spawn. You can call the run() function to execute a command and return the</span>
<span class="sd">output. This is a handy replacement for os.system().</span>

<span class="sd">For example::</span>

<span class="sd">    pexpect.run(&#39;ls -la&#39;)</span>

<span class="sd">The more powerful interface is the spawn class. You can use this to spawn an</span>
<span class="sd">external child command and then interact with the child by sending lines and</span>
<span class="sd">expecting responses.</span>

<span class="sd">For example::</span>

<span class="sd">    child = pexpect.spawn(&#39;scp foo myname@host.example.com:.&#39;)</span>
<span class="sd">    child.expect (&#39;Password:&#39;)</span>
<span class="sd">    child.sendline (mypassword)</span>

<span class="sd">This works even for commands that ask for passwords or other input outside of</span>
<span class="sd">the normal stdio streams.</span>

<span class="sd">Credits: Noah Spurrier, Richard Holden, Marco Molteni, Kimberley Burchett,</span>
<span class="sd">Robert Stone, Hartmut Goebel, Chad Schroeder, Erick Tryzelaar, Dave Kirby, Ids</span>
<span class="sd">vander Molen, George Todd, Noel Taylor, Nicolas D. Cesar, Alexander Gattin,</span>
<span class="sd">Geoffrey Marshall, Francisco Lourenco, Glen Mabey, Karthik Gurusamy, Fernando</span>
<span class="sd">Perez, Corey Minyard, Jon Cohen, Guillaume Chazarain, Andrew Ryan, Nick</span>
<span class="sd">Craig-Wood, Andrew Stone, Jorgen Grahn (Let me know if I forgot anyone.)</span>

<span class="sd">Free, open source, and all that good stuff.</span>

<span class="sd">Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="sd">this software and associated documentation files (the &quot;Software&quot;), to deal in</span>
<span class="sd">the Software without restriction, including without limitation the rights to</span>
<span class="sd">use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies</span>
<span class="sd">of the Software, and to permit persons to whom the Software is furnished to do</span>
<span class="sd">so, subject to the following conditions:</span>

<span class="sd">The above copyright notice and this permission notice shall be included in all</span>
<span class="sd">copies or substantial portions of the Software.</span>

<span class="sd">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="sd">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="sd">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="sd">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="sd">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="sd">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="sd">SOFTWARE.</span>

<span class="sd">Pexpect Copyright (c) 2008 Noah Spurrier</span>
<span class="sd">http://pexpect.sourceforge.net/</span>

<span class="sd">$Id: pexpect.py 507 2007-12-27 02:40:52Z noah $</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">import</span> <span class="nn">select</span>
    <span class="kn">import</span> <span class="nn">string</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">import</span> <span class="nn">struct</span>
    <span class="kn">import</span> <span class="nn">resource</span>
    <span class="kn">import</span> <span class="nn">types</span>
    <span class="kn">import</span> <span class="nn">pty</span>
    <span class="kn">import</span> <span class="nn">tty</span>
    <span class="kn">import</span> <span class="nn">termios</span>
    <span class="kn">import</span> <span class="nn">fcntl</span>
    <span class="kn">import</span> <span class="nn">errno</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="kn">import</span> <span class="nn">signal</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        A critical module was not found. Probably this operating system</span>
<span class="s">        does not support it. Pexpect is intended for UNIX-like</span>
<span class="s">        operating systems.&quot;&quot;&quot;</span>
    <span class="p">)</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;2.3&#39;</span>
<span class="n">__revision__</span> <span class="o">=</span> <span class="s">&#39;$Revision: 399 $&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;ExceptionPexpect&#39;</span><span class="p">,</span> <span class="s">&#39;EOF&#39;</span><span class="p">,</span> <span class="s">&#39;TIMEOUT&#39;</span><span class="p">,</span> <span class="s">&#39;spawn&#39;</span><span class="p">,</span> <span class="s">&#39;run&#39;</span><span class="p">,</span> <span class="s">&#39;which&#39;</span><span class="p">,</span>
    <span class="s">&#39;split_command_line&#39;</span><span class="p">,</span> <span class="s">&#39;__version__&#39;</span><span class="p">,</span> <span class="s">&#39;__revision__&#39;</span>
<span class="p">]</span>


<span class="c"># Exception classes used by this module.</span>
<div class="viewcode-block" id="ExceptionPexpect"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.ExceptionPexpect">[docs]</a><span class="k">class</span> <span class="nc">ExceptionPexpect</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Base class for all exceptions raised by this module.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="ExceptionPexpect.get_trace"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.ExceptionPexpect.get_trace">[docs]</a>    <span class="k">def</span> <span class="nf">get_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This returns an abbreviated stack trace with lines that only concern</span>
<span class="sd">        the caller. In other words, the stack trace inside the Pexpect module</span>
<span class="sd">        is not included. &quot;&quot;&quot;</span>

        <span class="n">tblist</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="c"># tblist = filter(self.__filter_not_pexpect, tblist)</span>
        <span class="n">tblist</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tblist</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_not_pexpect</span><span class="p">(</span><span class="n">item</span><span class="p">)]</span>
        <span class="n">tblist</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_list</span><span class="p">(</span><span class="n">tblist</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tblist</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__filter_not_pexpect</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">trace_list_item</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This returns True if list item 0 the string &#39;pexpect.py&#39; in it. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">trace_list_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;pexpect.py&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

</div>
<div class="viewcode-block" id="EOF"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.EOF">[docs]</a><span class="k">class</span> <span class="nc">EOF</span><span class="p">(</span><span class="n">ExceptionPexpect</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raised when EOF is read from a child.</span>
<span class="sd">        This usually means the child has exited.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="TIMEOUT"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.TIMEOUT">[docs]</a><span class="k">class</span> <span class="nc">TIMEOUT</span><span class="p">(</span><span class="n">ExceptionPexpect</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Raised when a read time exceeds the timeout. &quot;&quot;&quot;</span>

<span class="c"># # class TIMEOUT_PATTERN(TIMEOUT):</span>
<span class="c"># #    &quot;&quot;&quot;Raised when the pattern match time exceeds the timeout.</span>
<span class="c"># #    This is different than a read TIMEOUT because the child process may</span>
<span class="c"># #    give output, thus never give a TIMEOUT, but the output</span>
<span class="c"># #    may never match a pattern.</span>
<span class="c"># #    &quot;&quot;&quot;</span>
<span class="c"># # class MAXBUFFER(ExceptionPexpect):</span>
<span class="c"># #    &quot;&quot;&quot;Raised when a scan buffer fills before matching an expected pattern.&#39;</span>
<span class="c"># # &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
    <span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">withexitstatus</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">events</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function runs the given command; waits for it to finish; then</span>
<span class="sd">    returns all output as a string. STDERR is included in output. If the full</span>
<span class="sd">    path to the command is not given then the path is searched.</span>

<span class="sd">    Note that lines are terminated by CR/LF (\\r\\n) combination even on</span>
<span class="sd">    UNIX-like systems because this is the standard for pseudo ttys. If you set</span>
<span class="sd">    &#39;withexitstatus&#39; to true, then run will return a tuple of (command_output,</span>
<span class="sd">    exitstatus). If &#39;withexitstatus&#39; is false then this returns just</span>
<span class="sd">    command_output.</span>

<span class="sd">    The run() function can often be used instead of creating a spawn instance.</span>
<span class="sd">    For example, the following code uses spawn::</span>

<span class="sd">        from pexpect import *</span>
<span class="sd">        child = spawn(&#39;scp foo myname@host.example.com:.&#39;)</span>
<span class="sd">        child.expect (&#39;(?i)password&#39;)</span>
<span class="sd">        child.sendline (mypassword)</span>

<span class="sd">    The previous code can be replace with the following::</span>

<span class="sd">        from pexpect import *</span>
<span class="sd">        run (&#39;scp foo myname@host.example.com:.&#39;, events={</span>
<span class="sd">            &#39;(?i)password&#39;: mypassword}</span>
<span class="sd">        )</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    Start the apache daemon on the local machine::</span>

<span class="sd">        from pexpect import *</span>
<span class="sd">        run (&quot;/usr/local/apache/bin/apachectl start&quot;)</span>

<span class="sd">    Check in a file using SVN::</span>

<span class="sd">        from pexpect import *</span>
<span class="sd">        run (&quot;svn ci -m &#39;automatic commit&#39; my_file.py&quot;)</span>

<span class="sd">    Run a command and capture exit status::</span>

<span class="sd">        from pexpect import *</span>
<span class="sd">        (command_output, exitstatus) = run (&#39;ls -l /bin&#39;, withexitstatus=1)</span>

<span class="sd">    Tricky Examples</span>
<span class="sd">    ===============</span>

<span class="sd">    The following will run SSH and execute &#39;ls -l&#39; on the remote machine. The</span>
<span class="sd">    password &#39;secret&#39; will be sent if the &#39;(?i)password&#39; pattern is ever seen::</span>

<span class="sd">        run (&quot;ssh username@machine.example.com &#39;ls -l&#39;&quot;, events={&#39;(?i)password&#39;:&#39;secret\\n&#39;})</span>

<span class="sd">    This will start mencoder to rip a video from DVD. This will also display</span>
<span class="sd">    progress ticks every 5 seconds as it runs. For example::</span>

<span class="sd">        from pexpect import *</span>
<span class="sd">        def print_ticks(d):</span>
<span class="sd">            print d[&#39;event_count&#39;],</span>
<span class="sd">        run(</span>
<span class="sd">            &quot;mencoder dvd://1 -o video.avi -oac copy -ovc copy&quot;, </span>
<span class="sd">            events={TIMEOUT:print_ticks}, timeout=5</span>
<span class="sd">        )</span>

<span class="sd">    The &#39;events&#39; argument should be a dictionary of patterns and responses.</span>
<span class="sd">    Whenever one of the patterns is seen in the command out run() will send the</span>
<span class="sd">    associated response string. Note that you should put newlines in your</span>
<span class="sd">    string if Enter is necessary. The responses may also contain callback</span>
<span class="sd">    functions. Any callback is function that takes a dictionary as an argument.</span>
<span class="sd">    The dictionary contains all the locals from the run() function, so you can</span>
<span class="sd">    access the child spawn object or any other variable defined in run()</span>
<span class="sd">    (event_count, child, and extra_args are the most useful). A callback may</span>
<span class="sd">    return True to stop the current run process otherwise run() continues until</span>
<span class="sd">    the next event. A callback may also return a string which will be sent to</span>
<span class="sd">    the child. &#39;extra_args&#39; is not used by directly run(). It provides a way to</span>
<span class="sd">    pass data to a callback function through run() through the locals</span>
<span class="sd">    dictionary passed to a callback. &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">spawn</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">maxread</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="n">logfile</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">spawn</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">maxread</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="n">logfile</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># We assume that EOF or TIMEOUT will save us.</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">child_result_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">event_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">expect</span> <span class="p">(</span><span class="n">patterns</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">after</span><span class="p">)</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">StringTypes</span><span class="p">:</span>
                <span class="n">child_result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">before</span> <span class="o">+</span> <span class="n">child</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># child.after may have been a TIMEOUT or EOF, so don&#39;t cat those.</span>
                <span class="n">child_result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">responses</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">StringTypes</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">responses</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">responses</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="ow">is</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">:</span>
                <span class="n">callback_result</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">index</span><span class="p">](</span><span class="nb">locals</span><span class="p">())</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">callback_result</span><span class="p">)</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">StringTypes</span><span class="p">:</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">callback_result</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">callback_result</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span> <span class="p">(</span><span class="s">&#39;The callback must be a string or function type.&#39;</span><span class="p">)</span>
            <span class="n">event_count</span> <span class="o">=</span> <span class="n">event_count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">child_result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">EOF</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">child_result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="n">child_result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">child_result_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">withexitstatus</span><span class="p">:</span>
        <span class="n">child</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">child_result</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">exitstatus</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">child_result</span>
</div>
<div class="viewcode-block" id="spawn"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn">[docs]</a><span class="k">class</span> <span class="nc">spawn</span> <span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This is the main class interface for Pexpect. Use this class to start</span>
<span class="sd">    and control child applications. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">maxread</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">searchwindowsize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This is the constructor. The command parameter may be a string that</span>
<span class="sd">        includes a command and any arguments to the command. For example::</span>

<span class="sd">            child = pexpect.spawn (&#39;/usr/bin/ftp&#39;)</span>
<span class="sd">            child = pexpect.spawn (&#39;/usr/bin/ssh user@example.com&#39;)</span>
<span class="sd">            child = pexpect.spawn (&#39;ls -latr /tmp&#39;)</span>

<span class="sd">        You may also construct it with a list of arguments like so::</span>

<span class="sd">            child = pexpect.spawn (&#39;/usr/bin/ftp&#39;, [])</span>
<span class="sd">            child = pexpect.spawn (&#39;/usr/bin/ssh&#39;, [&#39;user@example.com&#39;])</span>
<span class="sd">            child = pexpect.spawn (&#39;ls&#39;, [&#39;-latr&#39;, &#39;/tmp&#39;])</span>

<span class="sd">        After this the child application will be created and will be ready to</span>
<span class="sd">        talk to. For normal use, see expect() and send() and sendline().</span>

<span class="sd">        Remember that Pexpect does NOT interpret shell meta characters such as</span>
<span class="sd">        redirect, pipe, or wild cards (&gt;, |, or *). This is a common mistake.</span>
<span class="sd">        If you want to run a command and pipe it through another command then</span>
<span class="sd">        you must also start a shell. For example::</span>

<span class="sd">            child = pexpect.spawn(&#39;/bin/bash -c &quot;ls -l | grep LOG &gt; log_list.txt&quot;&#39;)</span>
<span class="sd">            child.expect(pexpect.EOF)</span>

<span class="sd">        The second form of spawn (where you pass a list of arguments) is useful</span>
<span class="sd">        in situations where you wish to spawn a command and pass it its own</span>
<span class="sd">        argument list. This can make syntax more clear. For example, the</span>
<span class="sd">        following is equivalent to the previous example::</span>

<span class="sd">            shell_cmd = &#39;ls -l | grep LOG &gt; log_list.txt&#39;</span>
<span class="sd">            child = pexpect.spawn(&#39;/bin/bash&#39;, [&#39;-c&#39;, shell_cmd])</span>
<span class="sd">            child.expect(pexpect.EOF)</span>

<span class="sd">        The maxread attribute sets the read buffer size. This is maximum number</span>
<span class="sd">        of bytes that Pexpect will try to read from a TTY at one time. Setting</span>
<span class="sd">        the maxread size to 1 will turn off buffering. Setting the maxread</span>
<span class="sd">        value higher may help performance in cases where large amounts of</span>
<span class="sd">        output are read back from the child. This feature is useful in</span>
<span class="sd">        conjunction with searchwindowsize.</span>

<span class="sd">        The searchwindowsize attribute sets the how far back in the incomming</span>
<span class="sd">        seach buffer Pexpect will search for pattern matches. Every time</span>
<span class="sd">        Pexpect reads some data from the child it will append the data to the</span>
<span class="sd">        incomming buffer. The default is to search from the beginning of the</span>
<span class="sd">        imcomming buffer each time new data is read from the child. But this is</span>
<span class="sd">        very inefficient if you are running a command that generates a large</span>
<span class="sd">        amount of data where you want to match The searchwindowsize does not</span>
<span class="sd">        effect the size of the incomming data buffer. You will still have</span>
<span class="sd">        access to the full buffer after expect() returns.</span>

<span class="sd">        The logfile member turns on or off logging. All input and output will</span>
<span class="sd">        be copied to the given file object. Set logfile to None to stop</span>
<span class="sd">        logging. This is the default. Set logfile to sys.stdout to echo</span>
<span class="sd">        everything to standard output. The logfile is flushed after each write.</span>

<span class="sd">        Example log input and output to a file::</span>

<span class="sd">            child = pexpect.spawn(&#39;some_command&#39;)</span>
<span class="sd">            fout = file(&#39;mylog.txt&#39;,&#39;w&#39;)</span>
<span class="sd">            child.logfile = fout</span>

<span class="sd">        Example log to stdout::</span>

<span class="sd">            child = pexpect.spawn(&#39;some_command&#39;)</span>
<span class="sd">            child.logfile = sys.stdout</span>

<span class="sd">        The logfile_read and logfile_send members can be used to separately log</span>
<span class="sd">        the input from the child and output sent to the child. Sometimes you</span>
<span class="sd">        don&#39;t want to see everything you write to the child. You only want to</span>
<span class="sd">        log what the child sends back. For example::</span>

<span class="sd">            child = pexpect.spawn(&#39;some_command&#39;)</span>
<span class="sd">            child.logfile_read = sys.stdout</span>

<span class="sd">        To separately log output sent to the child use logfile_send::</span>

<span class="sd">            self.logfile_send = fout</span>

<span class="sd">        The delaybeforesend helps overcome a weird behavior that many users</span>
<span class="sd">        were experiencing. The typical problem was that a user would expect() a</span>
<span class="sd">        &quot;Password:&quot; prompt and then immediately call sendline() to send the</span>
<span class="sd">        password. The user would then see that their password was echoed back</span>
<span class="sd">        to them. Passwords don&#39;t normally echo. The problem is caused by the</span>
<span class="sd">        fact that most applications print out the &quot;Password&quot; prompt and then</span>
<span class="sd">        turn off stdin echo, but if you send your password before the</span>
<span class="sd">        application turned off echo, then you get your password echoed.</span>
<span class="sd">        Normally this wouldn&#39;t be a problem when interacting with a human at a</span>
<span class="sd">        real keyboard. If you introduce a slight delay just before writing then</span>
<span class="sd">        this seems to clear up the problem. This was such a common problem for</span>
<span class="sd">        many users that I decided that the default pexpect behavior should be</span>
<span class="sd">        to sleep just before writing to the child application. 1/20th of a</span>
<span class="sd">        second (50 ms) seems to be enough to clear up the problem. You can set</span>
<span class="sd">        delaybeforesend to 0 to return to the old behavior. Most Linux machines</span>
<span class="sd">        don&#39;t like this to be below 0.03. I don&#39;t know why.</span>

<span class="sd">        Note that spawn is clever about finding commands on your path.</span>
<span class="sd">        It uses the same logic that &quot;which&quot; uses to find executables.</span>

<span class="sd">        If you wish to get the exit status of the child you must call the</span>
<span class="sd">        close() method. The exit or signal status of the child will be stored</span>
<span class="sd">        in self.exitstatus or self.signalstatus. If the child exited normally</span>
<span class="sd">        then exitstatus will store the exit return code and signalstatus will</span>
<span class="sd">        be None. If the child was terminated abnormally with a signal then</span>
<span class="sd">        signalstatus will store the signal value and exitstatus will be None.</span>
<span class="sd">        If you need more detail you can also read the self.status member which</span>
<span class="sd">        stores the status returned by os.waitpid. You can interpret this using</span>
<span class="sd">        os.WIFEXITED/os.WEXITSTATUS or os.WIFSIGNALED/os.TERMSIG. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">STDIN_FILENO</span> <span class="o">=</span> <span class="n">pty</span><span class="o">.</span><span class="n">STDIN_FILENO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">STDOUT_FILENO</span> <span class="o">=</span> <span class="n">pty</span><span class="o">.</span><span class="n">STDOUT_FILENO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">STDERR_FILENO</span> <span class="o">=</span> <span class="n">pty</span><span class="o">.</span><span class="n">STDERR_FILENO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignorecase</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">before</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_index</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signalstatus</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># status returned by os.waitpid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag_eof</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># initially closed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span> <span class="o">=</span> <span class="n">EOF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">logfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logfile_read</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># input from child (read_nonblocking)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logfile_send</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># output to send (send, sendline)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxread</span> <span class="o">=</span> <span class="n">maxread</span> <span class="c"># max bytes to read at one time into buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># This is the read buffer. See maxread.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchwindowsize</span> <span class="o">=</span> <span class="n">searchwindowsize</span> <span class="c"># Anything before searchwindowsize point is preserved, but not searched.</span>
        <span class="c"># Most Linux machines don&#39;t like delaybeforesend to be below 0.03 (30 ms).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delaybeforesend</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="c"># Sets sleep time used just before sending data to child. Time in seconds.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayafterclose</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c"># Sets delay in close() method to allow kernel time to update process status. Time in seconds.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayafterterminate</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c"># Sets delay in terminate() method to allow kernel time to update process status. Time in seconds.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">softspace</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># File-like object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&gt;&#39;</span> <span class="c"># File-like object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># File-like object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># File-like object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cwd</span> <span class="o">=</span> <span class="n">cwd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__irix_hack</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;irix&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="c"># This flags if we are running on irix</span>
        <span class="c"># Solaris uses internal __fork_pty(). All others use pty.fork().</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;solaris&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;sunos5&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_native_pty_fork</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_native_pty_fork</span> <span class="o">=</span> <span class="bp">True</span>


        <span class="c"># allow dummy instances for subclasses that may not use command or args.</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&lt;pexpect factory incomplete&gt;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spawn</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This makes sure that no system resources are left open. Python only</span>
<span class="sd">        garbage collects Python objects. OS file descriptors are not Python</span>
<span class="sd">        objects, so they must be handled explicitly. If the child file</span>
<span class="sd">        descriptor was opened outside of this class (passed to the constructor)</span>
<span class="sd">        then this does not close it. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="c"># It is possible for __del__ methods to execute during the</span>
            <span class="c"># teardown of the Python VM itself. Thus self.close() may</span>
            <span class="c"># trigger an exception because os.close may be None.</span>
            <span class="c"># -- Fernando Perez</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This returns a human-readable string that represents the state of</span>
<span class="sd">        the object. &quot;&quot;&quot;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;version: &#39;</span> <span class="o">+</span> <span class="n">__version__</span> <span class="o">+</span> <span class="s">&#39; (&#39;</span> <span class="o">+</span> <span class="n">__revision__</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;command: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;args: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;searcher: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searcher</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;buffer (last 100 chars): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)[</span><span class="o">-</span><span class="mi">100</span><span class="p">:])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;before (last 100 chars): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">before</span><span class="p">)[</span><span class="o">-</span><span class="mi">100</span><span class="p">:])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;after: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;match: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;match_index: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">match_index</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;exitstatus: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exitstatus</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;flag_eof: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flag_eof</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;pid: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;child_fd: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;closed: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;timeout: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;delimiter: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;logfile: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;logfile_read: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile_read</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;logfile_send: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile_send</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;maxread: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxread</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;ignorecase: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ignorecase</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;searchwindowsize: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchwindowsize</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;delaybeforesend: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delaybeforesend</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;delayafterclose: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayafterclose</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;delayafterterminate: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayafterterminate</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_spawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">[]):</span>

        <span class="sd">&quot;&quot;&quot;This starts the given command in a child process. This does all the</span>
<span class="sd">        fork/exec type of stuff for a pty. This is called by __init__. If args</span>
<span class="sd">        is empty then command will be parsed (split on spaces) and args will be</span>
<span class="sd">        set to parsed arguments. &quot;&quot;&quot;</span>

        <span class="c"># The pid and child_fd of this object get set by this method.</span>
        <span class="c"># Note that it is difficult for this method to fail.</span>
        <span class="c"># You cannot detect if the child process cannot start.</span>
        <span class="c"># So the only way you can tell if the child process started</span>
        <span class="c"># or not is to try to read from the file descriptor. If you get</span>
        <span class="c"># EOF immediately then it means that the child is already dead.</span>
        <span class="c"># That may not necessarily be bad because you may haved spawned a child</span>
        <span class="c"># that performs some task; creates no stdout output; and then dies.</span>

        <span class="c"># If command is an int type then it may represent a file descriptor.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;Command is an int type. If this is a file descriptor then maybe you want to use fdpexpect.fdspawn which takes an existing file descriptor instead of a command string.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">([]):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span> <span class="p">(</span><span class="s">&#39;The argument, args, must be a list.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">split_command_line</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:]</span> <span class="c"># work with a copy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>

        <span class="n">command_with_path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command_with_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;The command was not found or was not executable: </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command_with_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&gt;&#39;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;The pid member should be None.&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;The command member should not be None.&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_native_pty_fork</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span> <span class="o">=</span> <span class="n">pty</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExceptionPexpect</span><span class="p">(</span><span class="s">&#39;Error! pty.fork() failed: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Use internal __fork_pty</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fork_pty</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Child</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span> <span class="c"># used by setwinsize()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setwinsize</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c"># Some platforms do not like setwinsize (Cygwin).</span>
                <span class="c"># This will cause problem when running applications that</span>
                <span class="c"># are very picky about window size.</span>
                <span class="c"># This is a serious limitation, but not a show stopper.</span>
                <span class="k">pass</span>
            <span class="c"># Do not allow child to inherit open file descriptors from parent.</span>
            <span class="n">max_fd</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_fd</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">close</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c"># I don&#39;t know why this works, but ignoring SIGHUP fixes a</span>
            <span class="c"># problem when trying to start a Java daemon with sudo</span>
            <span class="c"># (specifically, Tomcat).</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cwd</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">execv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">execvpe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>

        <span class="c"># Parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__fork_pty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This implements a substitute for the forkpty system call. This</span>
<span class="sd">        should be more portable than the pty.fork() function. Specifically,</span>
<span class="sd">        this should work on Solaris.</span>

<span class="sd">        Modified 10.06.05 by Geoff Marshall: Implemented __fork_pty() method to</span>
<span class="sd">        resolve the issue with Python&#39;s pty.fork() not supporting Solaris,</span>
<span class="sd">        particularly ssh. Based on patch to posixmodule.c authored by Noah</span>
<span class="sd">        Spurrier::</span>

<span class="sd">            http://mail.python.org/pipermail/python-dev/2003-May/035281.html</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">parent_fd</span><span class="p">,</span> <span class="n">child_fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parent_fd</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">child_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExceptionPexpect</span><span class="p">,</span> <span class="s">&quot;Error! Could not open pty with os.openpty().&quot;</span>

        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExceptionPexpect</span><span class="p">,</span> <span class="s">&quot;Error! Failed os.fork().&quot;</span>
        <span class="k">elif</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Child.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">parent_fd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pty_make_controlling_tty</span><span class="p">(</span><span class="n">child_fd</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">child_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">child_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">child_fd</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">child_fd</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">child_fd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Parent.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">child_fd</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pid</span><span class="p">,</span> <span class="n">parent_fd</span>

    <span class="k">def</span> <span class="nf">__pty_make_controlling_tty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tty_fd</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This makes the pseudo-terminal the controlling tty. This should be</span>
<span class="sd">        more portable than the pty.fork() function. Specifically, this should</span>
<span class="sd">        work on Solaris. &quot;&quot;&quot;</span>

        <span class="n">child_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">ttyname</span><span class="p">(</span><span class="n">tty_fd</span><span class="p">)</span>

        <span class="c"># Disconnect from controlling tty if still connected.</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/tty&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NOCTTY</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span>

        <span class="c"># Verify we are disconnected from controlling tty</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/tty&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NOCTTY</span><span class="p">);</span>
            <span class="k">if</span> <span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ExceptionPexpect</span><span class="p">,</span> <span class="s">&quot;Error! We are not disconnected from a controlling tty.&quot;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># Good! We are disconnected from a controlling tty.</span>
            <span class="k">pass</span>

        <span class="c"># Verify we can open child pty.</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">child_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExceptionPexpect</span><span class="p">,</span> <span class="s">&quot;Error! Could not open child pty, &quot;</span> <span class="o">+</span> <span class="n">child_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

        <span class="c"># Verify we now have a controlling tty.</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/tty&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExceptionPexpect</span><span class="p">,</span> <span class="s">&quot;Error! Could not open controlling tty, /dev/tty&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

<div class="viewcode-block" id="spawn.fileno"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.fileno">[docs]</a>    <span class="k">def</span> <span class="nf">fileno</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>   <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This returns the file descriptor of the pty for the child.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span>
</div>
<div class="viewcode-block" id="spawn.close"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>   <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This closes the connection with the child application. Note that</span>
<span class="sd">        calling close() more than once is valid. This emulates standard Python</span>
<span class="sd">        behavior with files. Set force to True if you want to make sure that</span>
<span class="sd">        the child is terminated (SIGKILL is sent if the child ignores SIGHUP</span>
<span class="sd">        and SIGINT). &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayafterclose</span><span class="p">)</span> <span class="c"># Give kernel time to update process status.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">(</span><span class="n">force</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;close() could not terminate the child using terminate()&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># self.pid = None</span>
</div>
<div class="viewcode-block" id="spawn.flush"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>   <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This does nothing. It is here to support the interface for a</span>
<span class="sd">        File-like object. &quot;&quot;&quot;</span>

        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="spawn.isatty"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.isatty">[docs]</a>    <span class="k">def</span> <span class="nf">isatty</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>   <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This returns True if the file descriptor is open and connected to a</span>
<span class="sd">        tty(-like) device, else False. &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">isatty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.waitnoecho"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.waitnoecho">[docs]</a>    <span class="k">def</span> <span class="nf">waitnoecho</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This waits until the terminal ECHO flag is set False. This returns</span>
<span class="sd">        True if the echo mode is off. This returns False if the ECHO flag was</span>
<span class="sd">        not set False before the timeout. This can be used to detect when the</span>
<span class="sd">        child is waiting for a password. Usually a child application will turn</span>
<span class="sd">        off echo mode when it is waiting for the user to enter a password. For</span>
<span class="sd">        example, instead of expecting the &quot;password:&quot; prompt you can wait for</span>
<span class="sd">        the child to set ECHO off::</span>

<span class="sd">            p = pexpect.spawn (&#39;ssh user@example.com&#39;)</span>
<span class="sd">            p.waitnoecho()</span>
<span class="sd">            p.sendline(mypassword)</span>

<span class="sd">        If timeout is None then this method to block forever until ECHO flag is</span>
<span class="sd">        False.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getecho</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.getecho"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.getecho">[docs]</a>    <span class="k">def</span> <span class="nf">getecho</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This returns the terminal echo mode. This returns True if echo is</span>
<span class="sd">        on or False if echo is off. Child applications that are expecting you</span>
<span class="sd">        to enter a password often set ECHO False. See waitnoecho(). &quot;&quot;&quot;</span>

        <span class="n">attr</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">termios</span><span class="o">.</span><span class="n">ECHO</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="spawn.setecho"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.setecho">[docs]</a>    <span class="k">def</span> <span class="nf">setecho</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This sets the terminal echo mode on or off. Note that anything the</span>
<span class="sd">        child sent before the echo will be lost, so you should be sure that</span>
<span class="sd">        your input buffer is empty before you call setecho(). For example, the</span>
<span class="sd">        following will work as expected::</span>

<span class="sd">            p = pexpect.spawn(&#39;cat&#39;)</span>
<span class="sd">            p.sendline (&#39;1234&#39;) # We will see this twice (once from tty echo and again from cat).</span>
<span class="sd">            p.expect ([&#39;1234&#39;])</span>
<span class="sd">            p.expect ([&#39;1234&#39;])</span>
<span class="sd">            p.setecho(False) # Turn off tty echo</span>
<span class="sd">            p.sendline (&#39;abcd&#39;) # We will set this only once (echoed by cat).</span>
<span class="sd">            p.sendline (&#39;wxyz&#39;) # We will set this only once (echoed by cat)</span>
<span class="sd">            p.expect ([&#39;abcd&#39;])</span>
<span class="sd">            p.expect ([&#39;wxyz&#39;])</span>

<span class="sd">        The following WILL NOT WORK because the lines sent before the setecho</span>
<span class="sd">        will be lost::</span>

<span class="sd">            p = pexpect.spawn(&#39;cat&#39;)</span>
<span class="sd">            p.sendline (&#39;1234&#39;) # We will see this twice (once from tty echo and again from cat).</span>
<span class="sd">            p.setecho(False) # Turn off tty echo</span>
<span class="sd">            p.sendline (&#39;abcd&#39;) # We will set this only once (echoed by cat).</span>
<span class="sd">            p.sendline (&#39;wxyz&#39;) # We will set this only once (echoed by cat)</span>
<span class="sd">            p.expect ([&#39;1234&#39;])</span>
<span class="sd">            p.expect ([&#39;1234&#39;])</span>
<span class="sd">            p.expect ([&#39;abcd&#39;])</span>
<span class="sd">            p.expect ([&#39;wxyz&#39;])</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">attr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="n">termios</span><span class="o">.</span><span class="n">ECHO</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">termios</span><span class="o">.</span><span class="n">ECHO</span>
        <span class="c"># I tried TCSADRAIN and TCSAFLUSH, but these were inconsistent</span>
        <span class="c"># and blocked on some platforms. TCSADRAIN is probably ideal if it worked.</span>
        <span class="n">termios</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TCSANOW</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.read_nonblocking"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.read_nonblocking">[docs]</a>    <span class="k">def</span> <span class="nf">read_nonblocking</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This reads at most size characters from the child application. It</span>
<span class="sd">        includes a timeout. If the read does not complete within the timeout</span>
<span class="sd">        period then a TIMEOUT exception is raised. If the end of file is read</span>
<span class="sd">        then an EOF exception will be raised. If a log file was set using</span>
<span class="sd">        setlog() then all data will also be written to the log file.</span>

<span class="sd">        If timeout is None then the read may block indefinitely. If timeout is -1</span>
<span class="sd">        then the self.timeout value is used. If timeout is 0 then the child is</span>
<span class="sd">        polled and if there was no data immediately ready then this will raise</span>
<span class="sd">        a TIMEOUT exception.</span>

<span class="sd">        The timeout refers only to the amount of time to read at least one</span>
<span class="sd">        character. This is not effected by the &#39;size&#39; parameter, so if you call</span>
<span class="sd">        read_nonblocking(size=100, timeout=30) and only one character is</span>
<span class="sd">        available right away then one character will be returned immediately.</span>
<span class="sd">        It will not wait for 30 seconds for another 99 characters to come in.</span>

<span class="sd">        This is a wrapper around os.read(). It uses select.select() to</span>
<span class="sd">        implement the timeout. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s">&#39;I/O operation on closed file in read_nonblocking().&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>

        <span class="c"># Note that some systems such as Solaris do not give an EOF when</span>
        <span class="c"># the child dies. In fact, you can still try to read</span>
        <span class="c"># from the child_fd -- it will block forever or until TIMEOUT.</span>
        <span class="c"># For this case, I test isalive() before doing any reading.</span>
        <span class="c"># If isalive() is false, then I pretend that this is the same as EOF.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
            <span class="n">r</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)</span> <span class="c"># timeout of 0 means &quot;poll&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flag_eof</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">raise</span> <span class="n">EOF</span> <span class="p">(</span><span class="s">&#39;End Of File (EOF) in read_nonblocking(). Braindead platform.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__irix_hack</span><span class="p">:</span>
            <span class="c"># This is a hack for Irix. It seems that Irix requires a long delay before checking isalive.</span>
            <span class="c"># This adds a 2 second delay, but only when the child is terminated.</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flag_eof</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">raise</span> <span class="n">EOF</span> <span class="p">(</span><span class="s">&#39;End Of File (EOF) in read_nonblocking(). Pokey platform.&#39;</span><span class="p">)</span>

        <span class="n">r</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="c"># Some platforms, such as Irix, will claim that their processes are alive;</span>
                <span class="c"># then timeout on the select; and then finally admit that they are not alive.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flag_eof</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">raise</span> <span class="n">EOF</span> <span class="p">(</span><span class="s">&#39;End of File (EOF) in read_nonblocking(). Very pokey platform.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TIMEOUT</span> <span class="p">(</span><span class="s">&#39;Timeout exceeded in read_nonblocking().&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="c"># Linux does this</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flag_eof</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">raise</span> <span class="n">EOF</span> <span class="p">(</span><span class="s">&#39;End Of File (EOF) in read_nonblocking(). Exception style platform.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="c"># BSD style</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flag_eof</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">raise</span> <span class="n">EOF</span> <span class="p">(</span><span class="s">&#39;End Of File (EOF) in read_nonblocking(). Empty string style platform.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile_read</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile_read</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logfile_read</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">s</span>

        <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;Reached an unexpected state in read_nonblocking().&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.read"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>   <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This reads at most &quot;size&quot; bytes from the file (less if the read hits</span>
<span class="sd">        EOF before obtaining size bytes). If the size argument is negative or</span>
<span class="sd">        omitted, read all data until EOF is reached. The bytes are returned as</span>
<span class="sd">        a string object. An empty string is returned when EOF is encountered</span>
<span class="sd">        immediately. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expect</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">)</span> <span class="c"># delimiter default is EOF</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">before</span>

        <span class="c"># I could have done this more directly by not using expect(), but</span>
        <span class="c"># I deliberately decided to couple read() to expect() so that</span>
        <span class="c"># I would catch any bugs early and ensure consistant behavior.</span>
        <span class="c"># It&#39;s a little less efficient, but there is less for me to</span>
        <span class="c"># worry about if I have to later modify read() or expect().</span>
        <span class="c"># Note, it&#39;s OK if size==-1 in the regex. That just means it</span>
        <span class="c"># will never match anything in which case we stop only on EOF.</span>
        <span class="n">cre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;.{</span><span class="si">%d</span><span class="s">}&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span> <span class="p">([</span><span class="n">cre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">])</span> <span class="c"># delimiter default is EOF</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">after</span> <span class="c"># # # self.before should be &#39;&#39;. Should I assert this?</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">before</span>
</div>
<div class="viewcode-block" id="spawn.readline"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>    <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This reads and returns one entire line. A trailing newline is kept</span>
<span class="sd">        in the string, but may be absent when a file ends with an incomplete</span>
<span class="sd">        line. Note: This readline() looks for a \\r\\n pair even on UNIX</span>
<span class="sd">        because this is what the pseudo tty device returns. So contrary to what</span>
<span class="sd">        you may expect you will receive the newline as \\r\\n. An empty string</span>
<span class="sd">        is returned when EOF is hit immediately. Currently, the size argument is</span>
<span class="sd">        mostly ignored, so this behavior is not standard for a file-like</span>
<span class="sd">        object. If size is 0 then an empty string is returned. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span> <span class="p">([</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">])</span> <span class="c"># delimiter default is EOF</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">before</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">before</span>
</div>
    <span class="k">def</span> <span class="nf">__iter__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>    <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This is to support iterators over a file-like object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="spawn.next"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>    <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This is to support iterators over a file-like object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="spawn.readlines"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizehint</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>    <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This reads until EOF using readline() and returns a list containing</span>
<span class="sd">        the lines thus read. The optional &quot;sizehint&quot; argument is ignored. &quot;&quot;&quot;</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>
</div>
<div class="viewcode-block" id="spawn.write"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>   <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This is similar to send() except that there is no return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.writelines"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.writelines">[docs]</a>    <span class="k">def</span> <span class="nf">writelines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>   <span class="c"># File-like object.</span>

        <span class="sd">&quot;&quot;&quot;This calls write() for each element in the sequence. The sequence</span>
<span class="sd">        can be any iterable object producing strings, typically a list of</span>
<span class="sd">        strings. This does not add line separators There is no return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.send"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This sends a string to the child process. This returns the number of</span>
<span class="sd">        bytes written. If a log file was set then the data is also written to</span>
<span class="sd">        the log. &quot;&quot;&quot;</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delaybeforesend</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile_send</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile_send</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile_send</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>
</div>
<div class="viewcode-block" id="spawn.sendline"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.sendline">[docs]</a>    <span class="k">def</span> <span class="nf">sendline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This is like send(), but it adds a line feed (os.linesep). This</span>
<span class="sd">        returns the number of bytes written. &quot;&quot;&quot;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span>
</div>
<div class="viewcode-block" id="spawn.sendcontrol"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.sendcontrol">[docs]</a>    <span class="k">def</span> <span class="nf">sendcontrol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This sends a control character to the child such as Ctrl-C or</span>
<span class="sd">        Ctrl-D. For example, to send a Ctrl-G (ASCII 7)::</span>

<span class="sd">            child.sendcontrol(&#39;g&#39;)</span>

<span class="sd">        See also, sendintr() and sendeof().</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">&gt;=</span><span class="mi">97</span> <span class="ow">and</span> <span class="n">a</span><span class="o">&lt;=</span><span class="mi">122</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span> <span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;@&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;`&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="s">&#39;[&#39;</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span> <span class="s">&#39;{&#39;</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span>
            <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span><span class="mi">28</span><span class="p">,</span> <span class="s">&#39;|&#39;</span><span class="p">:</span><span class="mi">28</span><span class="p">,</span>
            <span class="s">&#39;]&#39;</span><span class="p">:</span><span class="mi">29</span><span class="p">,</span> <span class="s">&#39;}&#39;</span><span class="p">:</span> <span class="mi">29</span><span class="p">,</span>
            <span class="s">&#39;^&#39;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span> <span class="s">&#39;~&#39;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
            <span class="s">&#39;_&#39;</span><span class="p">:</span><span class="mi">31</span><span class="p">,</span>
            <span class="s">&#39;?&#39;</span><span class="p">:</span><span class="mi">127</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span> <span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">char</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="spawn.sendeof"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.sendeof">[docs]</a>    <span class="k">def</span> <span class="nf">sendeof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This sends an EOF to the child. This sends a character which causes</span>
<span class="sd">        the pending parent output buffer to be sent to the waiting child</span>
<span class="sd">        program without waiting for end-of-line. If it is the first character</span>
<span class="sd">        of the line, the read() in the user program returns 0, which signifies</span>
<span class="sd">        end-of-file. This means to work as expected a sendeof() has to be</span>
<span class="sd">        called at the beginning of a line. This method does not send a newline.</span>
<span class="sd">        It is the responsibility of the caller to ensure the eof is sent at the</span>
<span class="sd">        beginning of a line. &quot;&quot;&quot;</span>

        <span class="c"># # # Hmmm... how do I send an EOF?</span>
        <span class="c"># # # C  if ((m = write(pty, *buf, p - *buf)) &lt; 0)</span>
        <span class="c"># # # C      return (errno == EWOULDBLOCK) ? n : -1;</span>
        <span class="c"># fd = sys.stdin.fileno()</span>
        <span class="c"># old = termios.tcgetattr(fd) # remember current state</span>
        <span class="c"># attr = termios.tcgetattr(fd)</span>
        <span class="c"># attr[3] = attr[3] | termios.ICANON # ICANON must be set to recognize EOF</span>
        <span class="c"># try: # use try/finally to ensure state gets restored</span>
        <span class="c">#    termios.tcsetattr(fd, termios.TCSADRAIN, attr)</span>
        <span class="c">#    if hasattr(termios, &#39;CEOF&#39;):</span>
        <span class="c">#        os.write (self.child_fd, &#39;%c&#39; % termios.CEOF)</span>
        <span class="c">#    else:</span>
        <span class="c">#        # Silly platform does not define CEOF so assume CTRL-D</span>
        <span class="c">#        os.write (self.child_fd, &#39;%c&#39; % 4)</span>
        <span class="c"># finally: # restore state</span>
        <span class="c">#    termios.tcsetattr(fd, termios.TCSADRAIN, old)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">termios</span><span class="p">,</span> <span class="s">&#39;VEOF&#39;</span><span class="p">):</span>
            <span class="n">char</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">)[</span><span class="mi">6</span><span class="p">][</span><span class="n">termios</span><span class="o">.</span><span class="n">VEOF</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># platform does not define VEOF so assume CTRL-D</span>
            <span class="n">char</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.sendintr"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.sendintr">[docs]</a>    <span class="k">def</span> <span class="nf">sendintr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This sends a SIGINT to the child. It does not require</span>
<span class="sd">        the SIGINT to be the first character on a line. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">termios</span><span class="p">,</span> <span class="s">&#39;VINTR&#39;</span><span class="p">):</span>
            <span class="n">char</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">)[</span><span class="mi">6</span><span class="p">][</span><span class="n">termios</span><span class="o">.</span><span class="n">VINTR</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># platform does not define VINTR so assume CTRL-C</span>
            <span class="n">char</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span> <span class="p">(</span><span class="n">char</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.eof"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.eof">[docs]</a>    <span class="k">def</span> <span class="nf">eof</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This returns True if the EOF exception was ever raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_eof</span>
</div>
<div class="viewcode-block" id="spawn.terminate"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.terminate">[docs]</a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This forces a child process to terminate. It starts nicely with</span>
<span class="sd">        SIGHUP and SIGINT. If &quot;force&quot; is True then moves onto SIGKILL. This</span>
<span class="sd">        returns True if the child was terminated. This returns False if the</span>
<span class="sd">        child could not be terminated. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayafterterminate</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCONT</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayafterterminate</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayafterterminate</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayafterterminate</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># I think there are kernel timing issues that sometimes cause</span>
            <span class="c"># this to happen. I think isalive() reports True, but the</span>
            <span class="c"># process is dead to the kernel.</span>
            <span class="c"># Make one last attempt to see if the kernel is up to date.</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayafterterminate</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="spawn.wait"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This waits until the child exits. This is a blocking call. This will</span>
<span class="sd">        not read any data from the child, so this will block forever if the</span>
<span class="sd">        child has unread output and has terminated. In other words, the child</span>
<span class="sd">        may have printed output then called exit(); but, technically, the child</span>
<span class="sd">        is still alive until its output is read. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
            <span class="n">pid</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;Cannot wait for dead child process.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFEXITED</span> <span class="p">(</span><span class="n">status</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signalstatus</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFSIGNALED</span> <span class="p">(</span><span class="n">status</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signalstatus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">WTERMSIG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFSTOPPED</span> <span class="p">(</span><span class="n">status</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;Wait was called for a child process that is stopped. This is not supported. Is some other process attempting job control with our child pid?&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitstatus</span>
</div>
<div class="viewcode-block" id="spawn.isalive"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.isalive">[docs]</a>    <span class="k">def</span> <span class="nf">isalive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This tests if the child process is running or not. This is</span>
<span class="sd">        non-blocking. If the child was terminated then this will read the</span>
<span class="sd">        exitstatus or signalstatus of the child. This returns True if the child</span>
<span class="sd">        process appears to be running or False if not. It can take literally</span>
<span class="sd">        SECONDS for Solaris to return the right status. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_eof</span><span class="p">:</span>
            <span class="c"># This is for Linux, which requires the blocking form of waitpid to get</span>
            <span class="c"># status of a defunct process. This is super-lame. The flag_eof would have</span>
            <span class="c"># been set in read_nonblocking(), so this should be safe.</span>
            <span class="n">waitpid_options</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">waitpid_options</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">WNOHANG</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pid</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">waitpid_options</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="c"># No child processes</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECHILD</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;isalive() encountered condition where &quot;terminated&quot; is 0, but there was no child process. Did someone else call waitpid() on our process?&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="c"># I have to do this twice for Solaris. I can&#39;t even believe that I figured this out...</span>
        <span class="c"># If waitpid() returns 0 it means that no child process wishes to</span>
        <span class="c"># report, and the value of status is undefined.</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pid</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">waitpid_options</span><span class="p">)</span> <span class="c"># # # os.WNOHANG) # Solaris!</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="c"># This should never happen...</span>
                <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECHILD</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;isalive() encountered condition that should never happen. There was no child process. Did someone else call waitpid() on our process?&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="c"># If pid is still 0 after two calls to waitpid() then</span>
            <span class="c"># the process really is alive. This seems to work on all platforms, except</span>
            <span class="c"># for Irix which seems to require a blocking call on waitpid or select, so I let read_nonblocking</span>
            <span class="c"># take care of this situation (unfortunately, this requires waiting through the timeout).</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFEXITED</span> <span class="p">(</span><span class="n">status</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signalstatus</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFSIGNALED</span> <span class="p">(</span><span class="n">status</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signalstatus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">WTERMSIG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFSTOPPED</span> <span class="p">(</span><span class="n">status</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;isalive() encountered condition where child process is stopped. This is not supported. Is some other process attempting job control with our child pid?&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="spawn.kill"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This sends the given signal to the child application. In keeping</span>
<span class="sd">        with UNIX tradition it has a misleading name. It does not necessarily</span>
<span class="sd">        kill the child unless you send the right signal. &quot;&quot;&quot;</span>

        <span class="c"># Same as os.kill, but the pid is given for you.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.compile_pattern_list"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.compile_pattern_list">[docs]</a>    <span class="k">def</span> <span class="nf">compile_pattern_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This compiles a pattern-string or a list of pattern-strings.</span>
<span class="sd">        Patterns must be a StringType, EOF, TIMEOUT, SRE_Pattern, or a list of</span>
<span class="sd">        those. Patterns may also be None which results in an empty list (you</span>
<span class="sd">        might do this if waiting for an EOF or TIMEOUT condition without</span>
<span class="sd">        expecting any pattern).</span>

<span class="sd">        This is used by expect() when calling expect_list(). Thus expect() is</span>
<span class="sd">        nothing more than::</span>

<span class="sd">             cpl = self.compile_pattern_list(pl)</span>
<span class="sd">             return self.expect_list(cpl, timeout)</span>

<span class="sd">        If you are using expect() within a loop it may be more</span>
<span class="sd">        efficient to compile the patterns first and then call expect_list().</span>
<span class="sd">        This avoid calls in a loop to compile_pattern_list()::</span>

<span class="sd">             cpl = self.compile_pattern_list(my_pattern)</span>
<span class="sd">             while some_condition:</span>
<span class="sd">                ...</span>
<span class="sd">                i = self.expect_list(clp, timeout)</span>
<span class="sd">                ...</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">patterns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">patterns</span><span class="p">]</span>

        <span class="n">compile_flags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="c"># Allow dot to match \n</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignorecase</span><span class="p">:</span>
            <span class="n">compile_flags</span> <span class="o">=</span> <span class="n">compile_flags</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
        <span class="n">compiled_pattern_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">StringTypes</span><span class="p">:</span>
                <span class="n">compiled_pattern_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">compile_flags</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">p</span> <span class="ow">is</span> <span class="n">EOF</span><span class="p">:</span>
                <span class="n">compiled_pattern_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span> <span class="ow">is</span> <span class="n">TIMEOUT</span><span class="p">:</span>
                <span class="n">compiled_pattern_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TIMEOUT</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)):</span>
                <span class="n">compiled_pattern_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span> <span class="p">(</span><span class="s">&#39;Argument must be one of StringTypes, EOF, TIMEOUT, SRE_Pattern, or a list of those type. </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">compiled_pattern_list</span>
</div>
<div class="viewcode-block" id="spawn.expect"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.expect">[docs]</a>    <span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">searchwindowsize</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This seeks through the stream until a pattern is matched. The</span>
<span class="sd">        pattern is overloaded and may take several types. The pattern can be a</span>
<span class="sd">        StringType, EOF, a compiled re, or a list of any of those types.</span>
<span class="sd">        Strings will be compiled to re types. This returns the index into the</span>
<span class="sd">        pattern list. If the pattern was not a list this returns index 0 on a</span>
<span class="sd">        successful match. This may raise exceptions for EOF or TIMEOUT. To</span>
<span class="sd">        avoid the EOF or TIMEOUT exceptions add EOF or TIMEOUT to the pattern</span>
<span class="sd">        list. That will cause expect to match an EOF or TIMEOUT condition</span>
<span class="sd">        instead of raising an exception.</span>

<span class="sd">        If you pass a list of patterns and more than one matches, the first match</span>
<span class="sd">        in the stream is chosen. If more than one pattern matches at that point,</span>
<span class="sd">        the leftmost in the pattern list is chosen. For example::</span>

<span class="sd">            # the input is &#39;foobar&#39;</span>
<span class="sd">            index = p.expect ([&#39;bar&#39;, &#39;foo&#39;, &#39;foobar&#39;])</span>
<span class="sd">            # returns 1 (&#39;foo&#39;) even though &#39;foobar&#39; is a &quot;better&quot; match</span>

<span class="sd">        Please note, however, that buffering can affect this behavior, since</span>
<span class="sd">        input arrives in unpredictable chunks. For example::</span>

<span class="sd">            # the input is &#39;foobar&#39;</span>
<span class="sd">            index = p.expect ([&#39;foobar&#39;, &#39;foo&#39;])</span>
<span class="sd">            # returns 0 (&#39;foobar&#39;) if all input is available at once,</span>
<span class="sd">            # but returs 1 (&#39;foo&#39;) if parts of the final &#39;bar&#39; arrive late</span>

<span class="sd">        After a match is found the instance attributes &#39;before&#39;, &#39;after&#39; and</span>
<span class="sd">        &#39;match&#39; will be set. You can see all the data read before the match in</span>
<span class="sd">        &#39;before&#39;. You can see the data that was matched in &#39;after&#39;. The</span>
<span class="sd">        re.MatchObject used in the re match will be in &#39;match&#39;. If an error</span>
<span class="sd">        occurred then &#39;before&#39; will be set to all the data read so far and</span>
<span class="sd">        &#39;after&#39; and &#39;match&#39; will be None.</span>

<span class="sd">        If timeout is -1 then timeout will be set to the self.timeout value.</span>

<span class="sd">        A list entry may be EOF or TIMEOUT instead of a string. This will</span>
<span class="sd">        catch these exceptions and return the index of the list entry instead</span>
<span class="sd">        of raising the exception. The attribute &#39;after&#39; will be set to the</span>
<span class="sd">        exception type. The attribute &#39;match&#39; will be None. This allows you to</span>
<span class="sd">        write code like this::</span>

<span class="sd">                index = p.expect ([&#39;good&#39;, &#39;bad&#39;, pexpect.EOF, pexpect.TIMEOUT])</span>
<span class="sd">                if index == 0:</span>
<span class="sd">                    do_something()</span>
<span class="sd">                elif index == 1:</span>
<span class="sd">                    do_something_else()</span>
<span class="sd">                elif index == 2:</span>
<span class="sd">                    do_some_other_thing()</span>
<span class="sd">                elif index == 3:</span>
<span class="sd">                    do_something_completely_different()</span>

<span class="sd">        instead of code like this::</span>

<span class="sd">                try:</span>
<span class="sd">                    index = p.expect ([&#39;good&#39;, &#39;bad&#39;])</span>
<span class="sd">                    if index == 0:</span>
<span class="sd">                        do_something()</span>
<span class="sd">                    elif index == 1:</span>
<span class="sd">                        do_something_else()</span>
<span class="sd">                except EOF:</span>
<span class="sd">                    do_some_other_thing()</span>
<span class="sd">                except TIMEOUT:</span>
<span class="sd">                    do_something_completely_different()</span>

<span class="sd">        These two forms are equivalent. It all depends on what you want. You</span>
<span class="sd">        can also just expect the EOF if you are waiting for all output of a</span>
<span class="sd">        child to finish. For example::</span>

<span class="sd">                p = pexpect.spawn(&#39;/bin/ls&#39;)</span>
<span class="sd">                p.expect (pexpect.EOF)</span>
<span class="sd">                print p.before</span>

<span class="sd">        If you are trying to optimize for speed then see expect_list().</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">compiled_pattern_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_pattern_list</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect_list</span><span class="p">(</span><span class="n">compiled_pattern_list</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">searchwindowsize</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.expect_list"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.expect_list">[docs]</a>    <span class="k">def</span> <span class="nf">expect_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern_list</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">searchwindowsize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This takes a list of compiled regular expressions and returns the</span>
<span class="sd">        index into the pattern_list that matched the child output. The list may</span>
<span class="sd">        also contain EOF or TIMEOUT (which are not compiled regular</span>
<span class="sd">        expressions). This method is similar to the expect() method except that</span>
<span class="sd">        expect_list() does not recompile the pattern list on every call. This</span>
<span class="sd">        may help if you are trying to optimize for speed, otherwise just use</span>
<span class="sd">        the expect() method.  This is called by expect(). If timeout==-1 then</span>
<span class="sd">        the self.timeout value is used. If searchwindowsize==-1 then the</span>
<span class="sd">        self.searchwindowsize value is used. &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect_loop</span><span class="p">(</span><span class="n">searcher_re</span><span class="p">(</span><span class="n">pattern_list</span><span class="p">),</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">searchwindowsize</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.expect_exact"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.expect_exact">[docs]</a>    <span class="k">def</span> <span class="nf">expect_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern_list</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">searchwindowsize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This is similar to expect(), but uses plain string matching instead</span>
<span class="sd">        of compiled regular expressions in &#39;pattern_list&#39;. The &#39;pattern_list&#39;</span>
<span class="sd">        may be a string; a list or other sequence of strings; or TIMEOUT and</span>
<span class="sd">        EOF.</span>

<span class="sd">        This call might be faster than expect() for two reasons: string</span>
<span class="sd">        searching is faster than RE matching and it is possible to limit the</span>
<span class="sd">        search to just the end of the input buffer.</span>

<span class="sd">        This method is also useful when you don&#39;t want to have to worry about</span>
<span class="sd">        escaping regular expression characters that you want to match.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pattern_list</span><span class="p">)</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">StringTypes</span> <span class="ow">or</span> <span class="n">pattern_list</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">EOF</span><span class="p">):</span>
            <span class="n">pattern_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect_loop</span><span class="p">(</span><span class="n">searcher_string</span><span class="p">(</span><span class="n">pattern_list</span><span class="p">),</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">searchwindowsize</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.expect_loop"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.expect_loop">[docs]</a>    <span class="k">def</span> <span class="nf">expect_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">searcher</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">searchwindowsize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This is the common loop used inside expect. The &#39;searcher&#39; should be</span>
<span class="sd">        an instance of searcher_re or searcher_string, which describes how and what</span>
<span class="sd">        to search for in the input.</span>

<span class="sd">        See expect() for other arguments, return value and exceptions. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">searcher</span> <span class="o">=</span> <span class="n">searcher</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">if</span> <span class="n">searchwindowsize</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">searchwindowsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchwindowsize</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">incoming</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span>
            <span class="n">freshlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">incoming</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span> <span class="c"># Keep reading until exception or return.</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">incoming</span><span class="p">,</span> <span class="n">freshlen</span><span class="p">,</span> <span class="n">searchwindowsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">incoming</span><span class="p">[</span><span class="n">searcher</span><span class="o">.</span><span class="n">end</span> <span class="p">:</span> <span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">before</span> <span class="o">=</span> <span class="n">incoming</span><span class="p">[</span> <span class="p">:</span> <span class="n">searcher</span><span class="o">.</span><span class="n">start</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">after</span> <span class="o">=</span> <span class="n">incoming</span><span class="p">[</span><span class="n">searcher</span><span class="o">.</span><span class="n">start</span> <span class="p">:</span> <span class="n">searcher</span><span class="o">.</span><span class="n">end</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">match</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">match_index</span> <span class="o">=</span> <span class="n">index</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_index</span>
                <span class="c"># No match at this point</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TIMEOUT</span> <span class="p">(</span><span class="s">&#39;Timeout exceeded in expect_any().&#39;</span><span class="p">)</span>
                <span class="c"># Still have time left, so read more data</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_nonblocking</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxread</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
                <span class="n">freshlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span> <span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
                <span class="n">incoming</span> <span class="o">=</span> <span class="n">incoming</span> <span class="o">+</span> <span class="n">c</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">timeout</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">EOF</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">before</span> <span class="o">=</span> <span class="n">incoming</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after</span> <span class="o">=</span> <span class="n">EOF</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">eof_index</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">EOF</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match_index</span> <span class="o">=</span> <span class="n">index</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_index</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match_index</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">raise</span> <span class="n">EOF</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">incoming</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">before</span> <span class="o">=</span> <span class="n">incoming</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after</span> <span class="o">=</span> <span class="n">TIMEOUT</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">timeout_index</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">TIMEOUT</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match_index</span> <span class="o">=</span> <span class="n">index</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_index</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match_index</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">raise</span> <span class="n">TIMEOUT</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">before</span> <span class="o">=</span> <span class="n">incoming</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">match_index</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">raise</span>
</div>
<div class="viewcode-block" id="spawn.getwinsize"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.getwinsize">[docs]</a>    <span class="k">def</span> <span class="nf">getwinsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This returns the terminal window size of the child tty. The return</span>
<span class="sd">        value is a tuple of (rows, cols). &quot;&quot;&quot;</span>

        <span class="n">TIOCGWINSZ</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">termios</span><span class="p">,</span> <span class="s">&#39;TIOCGWINSZ&#39;</span><span class="p">,</span> <span class="il">1074295912L</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;HHHH&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;HHHH&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="spawn.setwinsize"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.setwinsize">[docs]</a>    <span class="k">def</span> <span class="nf">setwinsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This sets the terminal window size of the child tty. This will cause</span>
<span class="sd">        a SIGWINCH signal to be sent to the child. This does not change the</span>
<span class="sd">        physical window size. It changes the size reported to TTY-aware</span>
<span class="sd">        applications like vi or curses -- applications that respond to the</span>
<span class="sd">        SIGWINCH signal. &quot;&quot;&quot;</span>

        <span class="c"># Check for buggy platforms. Some Python versions on some platforms</span>
        <span class="c"># (notably OSF1 Alpha and RedHat 7.1) truncate the value for</span>
        <span class="c"># termios.TIOCSWINSZ. It is not clear why this happens.</span>
        <span class="c"># These platforms don&#39;t seem to handle the signed int very well;</span>
        <span class="c"># yet other platforms like OpenBSD have a large negative value for</span>
        <span class="c"># TIOCSWINSZ and they don&#39;t have a truncate problem.</span>
        <span class="c"># Newer versions of Linux have totally different values for TIOCSWINSZ.</span>
        <span class="c"># Note that this fix is a hack.</span>
        <span class="n">TIOCSWINSZ</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">termios</span><span class="p">,</span> <span class="s">&#39;TIOCSWINSZ&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2146929561</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">TIOCSWINSZ</span> <span class="o">==</span> <span class="il">2148037735L</span><span class="p">:</span> <span class="c"># L is not required in Python &gt;= 2.2.</span>
            <span class="n">TIOCSWINSZ</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2146929561</span> <span class="c"># Same bits, but with sign.</span>
        <span class="c"># Note, assume ws_xpixel and ws_ypixel are zero.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;HHHH&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">TIOCSWINSZ</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.interact"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.interact">[docs]</a>    <span class="k">def</span> <span class="nf">interact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">escape_character</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">29</span><span class="p">),</span> <span class="n">input_filter</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">output_filter</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This gives control of the child process to the interactive user (the</span>
<span class="sd">        human at the keyboard). Keystrokes are sent to the child process, and</span>
<span class="sd">        the stdout and stderr output of the child process is printed. This</span>
<span class="sd">        simply echos the child stdout and child stderr to the real stdout and</span>
<span class="sd">        it echos the real stdin to the child stdin. When the user types the</span>
<span class="sd">        escape_character this method will stop. The default for</span>
<span class="sd">        escape_character is ^]. This should not be confused with ASCII 27 --</span>
<span class="sd">        the ESC character. ASCII 29 was chosen for historical merit because</span>
<span class="sd">        this is the character used by &#39;telnet&#39; as the escape character. The</span>
<span class="sd">        escape_character will not be sent to the child process.</span>

<span class="sd">        You may pass in optional input and output filter functions. These</span>
<span class="sd">        functions should take a string and return a string. The output_filter</span>
<span class="sd">        will be passed all the output from the child process. The input_filter</span>
<span class="sd">        will be passed all the keyboard input from the user. The input_filter</span>
<span class="sd">        is run BEFORE the check for the escape_character.</span>

<span class="sd">        Note that if you change the window size of the parent the SIGWINCH</span>
<span class="sd">        signal will not be passed through to the child. If you want the child</span>
<span class="sd">        window size to change when the parent&#39;s window size changes then do</span>
<span class="sd">        something like the following example::</span>

<span class="sd">            import pexpect, struct, fcntl, termios, signal, sys</span>
<span class="sd">            def sigwinch_passthrough (sig, data):</span>
<span class="sd">                s = struct.pack(&quot;HHHH&quot;, 0, 0, 0, 0)</span>
<span class="sd">                a = struct.unpack(&#39;hhhh&#39;, fcntl.ioctl(sys.stdout.fileno(), termios.TIOCGWINSZ , s))</span>
<span class="sd">                global p</span>
<span class="sd">                p.setwinsize(a[0],a[1])</span>
<span class="sd">            p = pexpect.spawn(&#39;/bin/bash&#39;) # Note this is global and used in sigwinch_passthrough.</span>
<span class="sd">            signal.signal(signal.SIGWINCH, sigwinch_passthrough)</span>
<span class="sd">            p.interact()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Flush the buffer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">tty</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STDIN_FILENO</span><span class="p">)</span>
        <span class="n">tty</span><span class="o">.</span><span class="n">setraw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STDIN_FILENO</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__interact_copy</span><span class="p">(</span><span class="n">escape_character</span><span class="p">,</span> <span class="n">input_filter</span><span class="p">,</span> <span class="n">output_filter</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">tty</span><span class="o">.</span><span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__interact_writen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This is used by the interact() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="n">data</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">__interact_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This is used by the interact() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__interact_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">escape_character</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">input_filter</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">output_filter</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This is used by the interact() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
            <span class="n">r</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STDIN_FILENO</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interact_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output_filter</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">output_filter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">STDIN_FILENO</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interact_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STDIN_FILENO</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">input_filter</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">input_filter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">escape_character</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__interact_writen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__interact_writen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_fd</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__select</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iwtd</span><span class="p">,</span> <span class="n">owtd</span><span class="p">,</span> <span class="n">ewtd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This is a wrapper around select.select() that ignores signals. If</span>
<span class="sd">        select.select raises a select.error exception and errno is an EINTR</span>
<span class="sd">        error then it is ignored. Mainly this is used to ignore sigwinch</span>
<span class="sd">        (terminal resize). &quot;&quot;&quot;</span>

        <span class="c"># if select() is interrupted by a signal (errno==EINTR) then</span>
        <span class="c"># we loop back and enter the select() again.</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span> <span class="p">(</span><span class="n">iwtd</span><span class="p">,</span> <span class="n">owtd</span><span class="p">,</span> <span class="n">ewtd</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">select</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                    <span class="c"># if we loop back we have to subtract the amount of time we already waited.</span>
                    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">timeout</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">([],[],[])</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># something else caused the select.error, so this really is an exception</span>
                    <span class="k">raise</span>

<span class="c"># # # ###########################################################################</span>
<span class="c"># The following methods are no longer supported or allowed.</span>

<div class="viewcode-block" id="spawn.setmaxread"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.setmaxread">[docs]</a>    <span class="k">def</span> <span class="nf">setmaxread</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxread</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This method is no longer supported or allowed. I don&#39;t like getters</span>
<span class="sd">        and setters without a good reason. &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;This method is no longer supported or allowed. Just assign a value to the maxread member variable.&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="spawn.setlog"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.spawn.setlog">[docs]</a>    <span class="k">def</span> <span class="nf">setlog</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobject</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This method is no longer supported or allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="n">ExceptionPexpect</span> <span class="p">(</span><span class="s">&#39;This method is no longer supported or allowed. Just assign a value to the logfile member variable.&#39;</span><span class="p">)</span>

<span class="c"># # # ###########################################################################</span>
<span class="c"># End of spawn class</span>
<span class="c"># # # ###########################################################################</span>
</div></div>
<span class="k">class</span> <span class="nc">searcher_string</span> <span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This is a plain string search helper for the spawn.expect_any() method.</span>

<span class="sd">    Attributes:</span>

<span class="sd">        eof_index     - index of EOF, or -1</span>
<span class="sd">        timeout_index - index of TIMEOUT, or -1</span>

<span class="sd">    After a successful match by the search() method the following attributes</span>
<span class="sd">    are available:</span>

<span class="sd">        start - index into the buffer, first byte of match</span>
<span class="sd">        end   - index into the buffer, first byte after match</span>
<span class="sd">        match - the matching string itself</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strings</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This creates an instance of searcher_string. This argument &#39;strings&#39;</span>
<span class="sd">        may be a list; a sequence of strings; or the EOF or TIMEOUT types. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eof_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">)),</span> <span class="n">strings</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="n">EOF</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eof_index</span> <span class="o">=</span> <span class="n">n</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="n">TIMEOUT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timeout_index</span> <span class="o">=</span> <span class="n">n</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This returns a human-readable string that represents the state of</span>
<span class="sd">        the object.&quot;&quot;&quot;</span>

        <span class="n">ss</span> <span class="o">=</span>  <span class="p">[</span> <span class="p">(</span><span class="n">ns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;    </span><span class="si">%d</span><span class="s">: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">ns</span><span class="p">)</span> <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strings</span> <span class="p">]</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;searcher_string:&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eof_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">append</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">eof_index</span><span class="p">,</span><span class="s">&#39;    </span><span class="si">%d</span><span class="s">: EOF&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">eof_index</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">append</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_index</span><span class="p">,</span><span class="s">&#39;    </span><span class="si">%d</span><span class="s">: TIMEOUT&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_index</span><span class="p">))</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ss</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">buffer</span><span class="p">,</span> <span class="n">freshlen</span><span class="p">,</span> <span class="n">searchwindowsize</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This searches &#39;buffer&#39; for the first occurence of one of the search</span>
<span class="sd">        strings.  &#39;freshlen&#39; must indicate the number of bytes at the end of</span>
<span class="sd">        &#39;buffer&#39; which have not been searched before. It helps to avoid</span>
<span class="sd">        searching the same, possibly big, buffer over and over again.</span>

<span class="sd">        See class spawn for the &#39;searchwindowsize&#39; argument.</span>

<span class="sd">        If there is a match this returns the index of that string, and sets</span>
<span class="sd">        &#39;start&#39;, &#39;end&#39; and &#39;match&#39;. Otherwise, this returns -1. &quot;&quot;&quot;</span>

        <span class="n">absurd_match</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
        <span class="n">first_match</span> <span class="o">=</span> <span class="n">absurd_match</span>

        <span class="c"># &#39;freshlen&#39; helps a lot here. Further optimizations could</span>
        <span class="c"># possibly include:</span>
        <span class="c">#</span>
        <span class="c"># using something like the Boyer-Moore Fast String Searching</span>
        <span class="c"># Algorithm; pre-compiling the search through a list of</span>
        <span class="c"># strings into something that can scan the input once to</span>
        <span class="c"># search for all N strings; realize that if we search for</span>
        <span class="c"># [&#39;bar&#39;, &#39;baz&#39;] and the input is &#39;...foo&#39; we need not bother</span>
        <span class="c"># rescanning until we&#39;ve read three more bytes.</span>
        <span class="c">#</span>
        <span class="c"># Sadly, I don&#39;t know enough about this interesting topic. /grahn</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">searchwindowsize</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># the match, if any, can only be in the fresh data,</span>
                <span class="c"># or at the very end of the old data</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">freshlen</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># better obey searchwindowsize</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">searchwindowsize</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">first_match</span><span class="p">:</span>
                <span class="n">first_match</span> <span class="o">=</span> <span class="n">n</span>
                <span class="n">best_index</span><span class="p">,</span> <span class="n">best_match</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">s</span>
        <span class="k">if</span> <span class="n">first_match</span> <span class="o">==</span> <span class="n">absurd_match</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">best_match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">first_match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_index</span>

<span class="k">class</span> <span class="nc">searcher_re</span> <span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This is regular expression string search helper for the</span>
<span class="sd">    spawn.expect_any() method.</span>

<span class="sd">    Attributes:</span>

<span class="sd">        eof_index     - index of EOF, or -1</span>
<span class="sd">        timeout_index - index of TIMEOUT, or -1</span>

<span class="sd">    After a successful match by the search() method the following attributes</span>
<span class="sd">    are available:</span>

<span class="sd">        start - index into the buffer, first byte of match</span>
<span class="sd">        end   - index into the buffer, first byte after match</span>
<span class="sd">        match - the re.match object returned by a succesful re.search</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This creates an instance that searches for &#39;patterns&#39; Where</span>
<span class="sd">        &#39;patterns&#39; may be a list or other sequence of compiled regular</span>
<span class="sd">        expressions, or the EOF or TIMEOUT types.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eof_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_searches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">patterns</span><span class="p">)),</span> <span class="n">patterns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="n">EOF</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eof_index</span> <span class="o">=</span> <span class="n">n</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="n">TIMEOUT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timeout_index</span> <span class="o">=</span> <span class="n">n</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_searches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This returns a human-readable string that represents the state of</span>
<span class="sd">        the object.&quot;&quot;&quot;</span>

        <span class="n">ss</span> <span class="o">=</span>  <span class="p">[</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="s">&#39;    </span><span class="si">%d</span><span class="s">: re.compile(&quot;</span><span class="si">%s</span><span class="s">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pattern</span><span class="p">)))</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_searches</span><span class="p">]</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;searcher_re:&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eof_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">append</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">eof_index</span><span class="p">,</span><span class="s">&#39;    </span><span class="si">%d</span><span class="s">: EOF&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">eof_index</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">append</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_index</span><span class="p">,</span><span class="s">&#39;    </span><span class="si">%d</span><span class="s">: TIMEOUT&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_index</span><span class="p">))</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ss</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">buffer</span><span class="p">,</span> <span class="n">freshlen</span><span class="p">,</span> <span class="n">searchwindowsize</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This searches &#39;buffer&#39; for the first occurence of one of the regular</span>
<span class="sd">        expressions. &#39;freshlen&#39; must indicate the number of bytes at the end of</span>
<span class="sd">        &#39;buffer&#39; which have not been searched before.</span>

<span class="sd">        See class spawn for the &#39;searchwindowsize&#39; argument.</span>

<span class="sd">        If there is a match this returns the index of that string, and sets</span>
<span class="sd">        &#39;start&#39;, &#39;end&#39; and &#39;match&#39;. Otherwise, returns -1.&quot;&quot;&quot;</span>

        <span class="n">absurd_match</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
        <span class="n">first_match</span> <span class="o">=</span> <span class="n">absurd_match</span>
        <span class="c"># &#39;freshlen&#39; doesn&#39;t help here -- we cannot predict the</span>
        <span class="c"># length of a match, and the re module provides no help.</span>
        <span class="k">if</span> <span class="n">searchwindowsize</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">searchstart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">searchstart</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span><span class="o">-</span><span class="n">searchwindowsize</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_searches</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span> <span class="n">searchstart</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">first_match</span><span class="p">:</span>
                <span class="n">first_match</span> <span class="o">=</span> <span class="n">n</span>
                <span class="n">the_match</span> <span class="o">=</span> <span class="n">match</span>
                <span class="n">best_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">if</span> <span class="n">first_match</span> <span class="o">==</span> <span class="n">absurd_match</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">first_match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">the_match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">best_index</span>

<div class="viewcode-block" id="which"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.which">[docs]</a><span class="k">def</span> <span class="nf">which</span> <span class="p">(</span><span class="n">filename</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This takes a given filename; tries to find it in the environment path;</span>
<span class="sd">    then checks if it is executable. This returns the full path to the filename</span>
<span class="sd">    if found and executable. Otherwise this returns None.&quot;&quot;&quot;</span>

    <span class="c"># Special case where filename already contains a path.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">filename</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;PATH&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">defpath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH&#39;</span><span class="p">]</span>

    <span class="c"># Oddly enough this was the one line that made Pexpect</span>
    <span class="c"># incompatible with Python 1.5.2.</span>
    <span class="c"># pathlist = p.split (os.pathsep)</span>
    <span class="n">pathlist</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">pathlist</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">f</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="split_command_line"><a class="viewcode-back" href="../../../cup.thirdp.html#cup.thirdp.pexpect.split_command_line">[docs]</a><span class="k">def</span> <span class="nf">split_command_line</span><span class="p">(</span><span class="n">command_line</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This splits a command line into a list of arguments. It splits arguments</span>
<span class="sd">    on spaces, but handles embedded quotes, doublequotes, and escaped</span>
<span class="sd">    characters. It&#39;s impossible to do this with a regular expression, so I</span>
<span class="sd">    wrote a little state machine to parse the command line. &quot;&quot;&quot;</span>

    <span class="n">arg_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="c"># Constants to name the states we can be in.</span>
    <span class="n">state_basic</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">state_esc</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">state_singlequote</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">state_doublequote</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">state_whitespace</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c"># The state of consuming whitespace between commands.</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">state_basic</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">command_line</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">state_basic</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="n">state_whitespace</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span> <span class="c"># Escape the next character</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">state_esc</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">r&quot;&#39;&quot;</span><span class="p">:</span> <span class="c"># Handle single quote</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">state_singlequote</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">r&#39;&quot;&#39;</span><span class="p">:</span> <span class="c"># Handle double quote</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">state_doublequote</span>
            <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                <span class="c"># Add arg to arg_list if we aren&#39;t in the middle of whitespace.</span>
                <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">state_whitespace</span><span class="p">:</span>
                    <span class="bp">None</span> <span class="c"># Do nothing.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="n">arg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">state_whitespace</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="n">c</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">state_basic</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">state_esc</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="n">c</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state_basic</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">state_singlequote</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">r&quot;&#39;&quot;</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">state_basic</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="n">c</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">state_doublequote</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">r&#39;&quot;&#39;</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">state_basic</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">if</span> <span class="n">arg</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arg_list</span>

<span class="c"># vi:ts=4:sw=4:expandtab:ft=python:</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">cup 1.2.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Author.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>